<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccessLetter - OAuth 2.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #121212;
            color: white;
            margin-top: 50px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #0078D4;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #005ea6;
        }
    </style>
</head>
<body>
    <h1>Welcome to AccessLetter!</h1>
    <p>This page is required to obtain tokens</p>
    <button id="loginButton">Login with Microsoft</button>

    <script>
        const clientId = 'ddd2c7a9-4ec4-49b0-be19-89de3d25fbbe';
        const tenant = 'common'; // Можно заменить на конкретный tenant ID
        const redirectUri = 'https://autoregx.github.io/AutoAcessX/';
        const scope = 'openid profile https://outlook.office365.com/IMAP.AccessAsUser.All';
        const responseType = 'code';
        const codeChallengeMethod = 'S256';

        function generateCodeVerifier() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            return Array.from(crypto.getRandomValues(new Uint8Array(43)))
                .map(x => characters[x % characters.length])
                .join('');
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        document.getElementById('loginButton').onclick = async function() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            const authorizationUrl = `https://login.microsoftonline.com/${tenant}/oauth2/v2.0/authorize?` +
                `client_id=${clientId}&` +
                `response_type=${responseType}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `scope=${encodeURIComponent(scope)}&` +
                `code_challenge=${codeChallenge}&` +
                `code_challenge_method=${codeChallengeMethod}`;

            sessionStorage.setItem('code_verifier', codeVerifier);
            window.location.href = authorizationUrl;
        };
    </script>
</body>
</html>
